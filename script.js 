// Hamburger menu toggle
const menuToggle = document.getElementById('menu-toggle');
const navLinks = document.getElementById('nav-links');

menuToggle.addEventListener('click', () => {
  const expanded = menuToggle.getAttribute('aria-expanded') === 'true' || false;
  menuToggle.setAttribute('aria-expanded', !expanded);
  navLinks.classList.toggle('show');
});

// Dropdown keyboard accessibility
document.querySelectorAll('.dropdown').forEach(dropdown => {
  const btn = dropdown.querySelector('.dropbtn');
  const menu = dropdown.querySelector('.dropdown-content');
  btn.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', !expanded);
      if (!expanded) {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }
  });
});

// Modal logic for event popups
function openModal(id) {
  const modal = document.getElementById(id);
  modal.style.display = 'block';
  modal.focus();
  // trap focus inside modal
  trapFocus(modal);
}
function closeModal(id) {
  const modal = document.getElementById(id);
  modal.style.display = 'none';
}
// Close modal on click outside or Escape key
window.onclick = function(event) {
  document.querySelectorAll('.modal').forEach(modal => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
};
window.addEventListener('keydown', event => {
  if (event.key === 'Escape') {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.style.display = 'none';
    });
  }
});

// Trap focus inside modal for accessibility
function trapFocus(element) {
  const focusableEls = element.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
  const firstFocusableEl = focusableEls[0];
  const lastFocusableEl = focusableEls[focusableEls.length - 1];
  element.addEventListener('keydown', e => {
    let isTabPressed = e.key === 'Tab' || e.keyCode === 9;
    if (!isTabPressed) return;
    if (e.shiftKey) {
      // Shift + Tab
      if (document.activeElement === firstFocusableEl) {
        lastFocusableEl.focus();
        e.preventDefault();
      }
    } else {
      // Tab
      if (document.activeElement === lastFocusableEl) {
        firstFocusableEl.focus();
        e.preventDefault();
      }
    }
  });
}

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function(e) {
    const targetEl = document.querySelector(this.getAttribute('href'));
    if (targetEl) {
      e.preventDefault();
      targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Close nav menu on mobile after clicking a link
      if (navLinks.classList.contains('show')) {
        navLinks.classList.remove('show');
        menuToggle.setAttribute('aria-expanded', false);
      }
    }
  });
});

// Gallery Lightbox
const lightboxModal = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxDesc = document.getElementById('lightbox-desc');

function openLightbox(img) {
  lightboxImg.src = img.src;
  lightboxImg.alt = img.alt;
  lightboxDesc.textContent = img.alt;
  lightboxModal.style.display = 'block';
  lightboxModal.focus();
  trapFocus(lightboxModal);
}

function closeLightbox() {
  lightboxModal.style.display = 'none';
}

lightboxModal.querySelector('.close').addEventListener('click', closeLightbox);
window.addEventListener('keydown', event => {
  if (event.key === 'Escape' && lightboxModal.style.display === 'block') {
    closeLightbox();
  }
});
window.addEventListener('click', event => {
  if (event.target === lightboxModal) {
    closeLightbox();
  }
});

// Contact Form Validation
const contactForm = document.getElementById('contact-form');
const feedback = document.getElementById('form-feedback');

contactForm.addEventListener('submit', e => {
  e.preventDefault();
  const name = contactForm.name.value.trim();
  const email = contactForm.email.value.trim();
  const message = contactForm.message.value.trim();
  let valid = true;
  let messages = [];

  if (name.length < 3) {
    valid = false;
    messages.push('Name must be at least 3 characters.');
  }
  if (!validateEmail(email)) {
    valid = false;
    messages.push('Please enter a valid email.');
  }
  if (message.length < 10) {
    valid = false;
    messages.push('Message must be at least 10 characters.');
  }

  if (!valid) {
    feedback.textContent = messages.join(' ');
    return;
  }
  feedback.textContent = '';
  alert('Thank you for contacting us! We\'ll get back to you soon.');
  contactForm.reset();
});

function validateEmail(email) {
  const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@(([^<>()\[\]\\.,;:\s@"]+\.)+[^<>()[\]\.,;:\s@"]{2,})$/i;
  return re.test(email);
}

// Scroll animations via Intersection Observer
const animItems = document.querySelectorAll('.fade-in, .event-card, .gallery-img, .leaderboard');
const observer = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('visible');
    }
  });
}, { threshold: 0.1 });
animItems.forEach(item => {
  observer.observe(item);
});
